{% extends 'base.html' %}
{% load static %}

{% block title %}Crea tu cuenta | SERCONN{% endblock %}

{% block content %}
<section class="flex items-center justify-center py-16 px-4 bg-gradient-to-br from-white via-brand-background to-white">
  <div class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-3xl backdrop-blur-sm">
    
    <!-- Step 1: Role Selection -->
    <div id="roleSelectionStep">
      <h2 class="text-3xl font-bold text-center text-brand-text mb-2">Únete a SERCONN</h2>
      <p class="text-center text-sm text-gray-600 mb-8">Para empezar, dinos qué quieres hacer en la plataforma</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Service Seeker Option -->
        <button type="button" data-role="service_seeker" class="role-btn group p-6 border-2 border-gray-200 rounded-xl text-left hover:border-brand-secondary hover:shadow-lg transition-all duration-300">
          <div class="flex flex-col gap-3">
            <div class="bg-brand-secondary/10 text-brand-secondary p-4 rounded-full w-fit group-hover:scale-110 transition-transform duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <div>
              <h3 class="font-bold text-brand-text text-xl mb-1">Buscar servicios</h3>
              <p class="text-sm text-gray-600">Encuentra y contrata profesionales de confianza para tus necesidades</p>
            </div>
          </div>
        </button>

        <!-- Service Provider Option -->
        <button type="button" data-role="service_provider" class="role-btn group p-6 border-2 border-gray-200 rounded-xl text-left hover:border-brand-primary hover:shadow-lg transition-all duration-300">
          <div class="flex flex-col gap-3">
            <div class="bg-brand-primary/10 text-brand-primary p-4 rounded-full w-fit group-hover:scale-110 transition-transform duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
            <div>
              <h3 class="font-bold text-brand-text text-xl mb-1">Ofrecer servicios</h3>
              <p class="text-sm text-gray-600">Consigue nuevos clientes y haz crecer tu negocio profesional</p>
            </div>
          </div>
        </button>
      </div>
    </div>

    <!-- Step 2: Registration Form -->
    <form method="post" enctype="multipart/form-data" id="registerForm" class="hidden">
      {% csrf_token %}
      {{ form.user_role }}

      <div class="flex justify-between items-center mb-6 pb-4 border-b">
        <h2 class="text-3xl font-bold text-brand-text">Completa tus datos</h2>
        <button type="button" id="changeRoleBtn" class="text-sm font-semibold text-brand-secondary hover:text-brand-primary transition duration-300 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
          </svg>
          Cambiar rol
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for field in form %}
          {% if field.name != 'user_role' and field.name != 'description' %}
            <div class="{% if field.name == 'user_picture' or field.name == 'user_address' %}md:col-span-2{% endif %}">
              <label for="{{ field.id_for_label }}" class="block text-brand-text font-semibold mb-2">
                {{ field.label }}
              </label>
              
              {% if field.field.widget.input_type == 'select' %}
                {{ field }}
              {% elif field.field.widget.input_type == 'file' %}
                <input type="file" name="{{ field.name }}" id="{{ field.id_for_label }}" accept="image/*" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent transition file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-primary/10 file:text-brand-primary hover:file:bg-brand-primary/20">
              {% elif field.field.widget.input_type == 'textarea' %}
                <textarea name="{{ field.name }}" id="{{ field.id_for_label }}" rows="3" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent transition">{{ field.value|default:'' }}</textarea>
              {% else %}
                <input type="{{ field.field.widget.input_type }}" name="{{ field.name }}" id="{{ field.id_for_label }}" {% if field.field.required %}required{% endif %} class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent transition">
              {% endif %}
              
              <p id="{{ field.id_for_label }}-error" class="text-red-600 text-sm mt-1 hidden"></p>
              
              {% if field.errors %}
                <p class="text-red-600 text-sm mt-1">{{ field.errors|first }}</p>
              {% endif %}
              
              {% if field.name == 'password1' %}
                <div class="mt-3 p-4 bg-brand-background rounded-lg border border-gray-200">
                  <p class="text-xs font-semibold text-gray-700 mb-2">Requisitos de contraseña:</p>
                  <ul class="list-disc list-inside text-xs text-gray-600 space-y-1">
                    <li>Mínimo 8 caracteres</li>
                    <li>No puede ser demasiado común</li>
                    <li>Debe contener letras y números</li>
                  </ul>
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- Provider Description Field -->
        <div id="providerFields" class="md:col-span-2 hidden">
          <label for="{{ form.description.id_for_label }}" class="block text-brand-text font-semibold mb-2">
            {{ form.description.label }}
          </label>
          <textarea name="description" id="{{ form.description.id_for_label }}" rows="4" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent transition" placeholder="Cuéntanos sobre tus servicios, experiencia y especialidades..."></textarea>
          
          <p id="{{ form.description.id_for_label }}-error" class="text-red-600 text-sm mt-1 hidden"></p>
          
          {% if form.description.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.description.errors|first }}</p>
          {% endif %}
        </div>
      </div>

      <button type="submit" id="submit-btn-js" class="w-full bg-brand-primary hover:bg-brand-secondary text-white font-bold py-3 rounded-full shadow-md shadow-brand-primary/30 hover:shadow-lg hover:shadow-brand-secondary/30 transition-all duration-300 mt-8">
        Crear mi cuenta
      </button>
    </form>

    <p class="text-center text-gray-600 mt-6">
      ¿Ya tienes una cuenta?
      <a href="{% url 'login' %}" class="text-brand-secondary hover:text-brand-primary hover:underline font-semibold transition">
        Inicia sesión
      </a>
    </p>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const roleButtons = document.querySelectorAll('.role-btn');
  const roleSelectionStep = document.getElementById('roleSelectionStep');
  const registerForm = document.getElementById('registerForm');
  const userRoleInput = document.querySelector('input[name="user_role"]');
  const changeRoleBtn = document.getElementById('changeRoleBtn');
  const providerFields = document.getElementById('providerFields');

  roleButtons.forEach(button => {
    button.addEventListener('click', function() {
      const selectedRole = this.getAttribute('data-role');
      userRoleInput.value = selectedRole;
      
      roleSelectionStep.classList.add('hidden');
      registerForm.classList.remove('hidden');
      
      if (selectedRole === 'service_provider') {
        providerFields.classList.remove('hidden');
      } else {
        providerFields.classList.add('hidden');
      }
    });
  });

  changeRoleBtn.addEventListener('click', function() {
    registerForm.classList.add('hidden');
    roleSelectionStep.classList.remove('hidden');
    providerFields.classList.add('hidden');
  });
});
</script>
{% endblock %}