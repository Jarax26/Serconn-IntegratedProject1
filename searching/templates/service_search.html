{% extends 'base.html' %}
{% block title %}Buscar servicios | SERCONN{% endblock %}

{% block content %}
    <main class="container mx-auto px-4 py-8 md:py-12 flex-grow">

        {% if user.is_authenticated and user.is_service_seeker %}
        <div class="max-w-md mx-auto my-8 bg-white rounded-2xl shadow-lg p-6 flex items-center gap-6">
            {% if user.user_picture %}
            <img src="{{ user.user_picture.url }}" alt="Foto de perfil"
                class="w-20 h-20 rounded-full object-cover">
            {% else %}
            <div class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-2xl font-bold">
                {{ user.username|slice:":1" }}
            </div>
            {% endif %}
            <div>
                <h3 class="text-xl font-bold text-brand-primary">{{ user.get_full_name|default:user.username }}</h3>
                <p class="text-gray-600"> Score: {{ user.user_score }} ⭐</p>
                <a href="{% url 'dashboard' %}" class="text-brand-primary hover:text-brand-secondary hover:underline  font-semibold block mt-2">Ver mis solicitudes</a>
            </div>
        </div>
        {% endif %}
        
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Encuentra el servicio que necesitas</h2>
            
            <form action="{% url 'service_search' %}" method="get" class="space-y-4">
                
                <div class="flex items-center gap-4">
                    <input type="text" name="query" placeholder="Ej: Plomero, Tutor de inglés..." value="{{ query|default:'' }}" 
                        class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-brand-secondary transition-all duration-200">
                    <button type="button" id="filter-toggle-btn" class="flex-shrink-0 px-6 py-3 bg-gray-100 text-gray-800 font-semibold rounded-full shadow-sm hover:bg-brand-primary transition">
                        Filtrar búsqueda
                    </button>
                </div>

                <div id="filter-container" class="hidden border-t pt-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 text-center mb-1">Categoría</label>
                            <select id="category" name="category" class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                                <option value="">Todas las categorías</option>
                                {% for category in categories %}
                                    <option value="{{ category.name }}" {% if category.name == selected_category %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="city" class="block text-sm font-medium text-gray-700 text-center mb-1">Ciudad</label>
                            <select id="city" name="city" class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                                <option value="">Todas las ciudades</option>
                                {% for city_value, city_name in cities %}
                                    <option value="{{ city_value }}" {% if city_value == selected_city %}selected{% endif %}>
                                        {{ city_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="availability_start" class="block text-sm font-medium text-gray-700 text-center mb-1">Disponible desde</label>
                            <input type="datetime-local" id="availability_start" name="availability_start" value="{{ availability_start|default:'' }}"
                                class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                        </div>
                        <div>
                            <label for="availability_end" class="block text-sm font-medium text-gray-700 text-center mb-1">Disponible hasta</label>
                            <input type="datetime-local" id="availability_end" name="availability_end" value="{{ availability_end|default:'' }}"
                                class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-brand-primary hover:bg-brand-secondary text-white font-bold py-3 rounded-full transition-colors duration-300 shadow-lg">
                    Buscar
                </button>
            </form>
        </div>

        <section class="mt-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Resultados de búsqueda</h2>
            {% if providers %}
                <ul class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for provider in providers %}
                        {% if provider.services.count > 0 %}
                            <li class="bg-white p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col">
                                <a href="{% url 'provider_detail' provider.id %}" class="flex-grow">
                                    <div class="flex items-center mb-4">
                                        {% if provider.user.user_picture %}
                                            <img src="{{ provider.user.user_picture.url }}" alt="Foto de perfil de {{ provider.user }}" class="w-16 h-16 rounded-full object-cover mr-4">
                                        {% else %}
                                            <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xl font-bold mr-4">
                                                {{ provider.user.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                        <div>
                                            <h3 class="text-xl font-semibold text-brand-primary hover:text-indigo-800 transition-colors duration-200">{{ provider.user.get_full_name|default:provider.user.username }}</h3>
                                            <p class="text-sm text-gray-500">Proveedor de servicios</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-600 font-bold">Score: {{ provider.user.user_score }} ⭐</p>
                                    <p class="text-gray-600 mt-2">{{ provider.user.service_provider_profile.description|default:"Sin descripción" }}</p>
                                </a>

                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <h4 class="font-semibold text-gray-700 mb-2">Servicios que ofrece:</h4>
                                    <ul class="list-disc list-inside text-gray-600">
                                        {% for service in provider.services.all|slice:":3" %}
                                            <li>{{ service.name }} - <span class="font-bold">${{ service.rate|floatformat:0 }}</span></li>
                                        {% endfor %}
                                        {% if provider.services.count > 3 %}
                                            <li><a href="{% url 'provider_detail' provider.id %}" class="text-sm text-gray-500 font-bold hover:text-indigo-800 transition-colors duration-200">...y más.</a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-center text-gray-500 p-8 bg-gray-50 rounded-2xl shadow-inner">
                    <p class="text-lg">No se encontraron proveedores que coincidan con la búsqueda.</p>
                    <p class="mt-2">Intenta con otros términos o categorías.</p>
                </div>
            {% endif %}
        </section>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Menú desplegable del perfil
        const menuBtn = document.getElementById('profile-menu-btn');
        const dropdown = document.getElementById('profile-dropdown');

        if (menuBtn && dropdown) {
            menuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', function(e) {
                if (!dropdown.classList.contains('hidden')) {
                    dropdown.classList.add('hidden');
                }
            });

            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // Menú desplegable de filtros
        const filterToggleBtn = document.getElementById('filter-toggle-btn');
        const filterContainer = document.getElementById('filter-container');

        if (filterToggleBtn && filterContainer) {
            filterToggleBtn.addEventListener('click', function() {
                filterContainer.classList.toggle('hidden');
            });
        }
    });
    </script>
{% endblock %}